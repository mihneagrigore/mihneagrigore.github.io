<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure PDF Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    #viewer { width: 100%; height: 80vh; border: none; }
    #error { color: red; }
  </style>
</head>
<body>

<h1>Secure PDF Viewer</h1>
<div id="content">
  <!-- Dynamic content goes here -->
</div>

<script>
  async function validateKey(publicKey, fileName) {
    try {
      const response = await fetch(`https://pdf-key-generator.amihnea2.workers.dev/?publicKey=${encodeURIComponent(publicKey)}`);
      if (!response.ok) throw new Error('API request failed');

      const data = await response.json();

      if (data.valid && data.driveLink) {
        // Embed the Google Drive link for the file
        // Assuming the driveLink includes a placeholder or the full link for this file
        // If the API returns a generic driveLink, you may want to append fileName or modify here accordingly.

        // For now, assuming driveLink is the full embeddable link for the requested file
        return { success: true, link: data.driveLink };
      } else {
        return { success: false, message: 'Invalid public key or no link returned.' };
      }
    } catch (error) {
      return { success: false, message: 'Error contacting the key validation API.' };
    }
  }

  function renderPrompt(fileName) {
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = `
      <p>Please enter your public key to access <strong>${fileName}</strong>:</p>
      <input type="text" id="keyInput" placeholder="Enter your key" />
      <button id="submitKey">Submit</button>
      <p id="error"></p>
    `;

    document.getElementById('submitKey').addEventListener('click', async () => {
      const key = document.getElementById('keyInput').value.trim();
      if (!key) {
        document.getElementById('error').textContent = 'Key cannot be empty.';
        return;
      }
      document.getElementById('error').textContent = 'Validating...';
      const result = await validateKey(key, fileName);
      if (result.success) {
        renderViewer(result.link);
        // Optionally update the URL with ?key=... so page can be reloaded
        history.replaceState(null, '', `?file=${encodeURIComponent(fileName)}&key=${encodeURIComponent(key)}`);
      } else {
        document.getElementById('error').textContent = result.message;
      }
    });
  }

  function renderViewer(driveLink) {
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = `
      <iframe id="viewer" src="${driveLink}" allowfullscreen></iframe>
    `;
  }

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const fileName = params.get('file');
    const key = params.get('key');

    if (!fileName) {
      document.getElementById('content').innerHTML = '<p>No file specified in the URL.</p>';
      return;
    }

    if (!key) {
      renderPrompt(fileName);
    } else {
      document.getElementById('content').innerHTML = '<p>Validating key, please wait...</p>';
      const result = await validateKey(key, fileName);
      if (result.success) {
        renderViewer(result.link);
      } else {
        renderPrompt(fileName);
        document.getElementById('error').textContent = result.message;
      }
    }
  }

  main();
</script>

</body>
</html>
